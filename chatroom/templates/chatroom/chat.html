{% extends 'login/cb.html' %}

{% load staticfiles %}

{% block header %}
<div class="row">
    <div class="col-sm-4 col-sm-offset-4">
			{% if topic %}
				<h1><span style="color:#6E6E6E">Chatroom: </span><b>#{{ topic }}</b></h1>
			{% else %}
				<h1><span style="color:#6E6E6E">Chatroom: </span><b>#Room{{ id }}</b></h1>
			{% endif %}
    </div>
</div>
{% endblock %}

{% block content %}
<script type="text/javascript">
$(function(){
	updateMsg();
	$("#messageForm").submit(function(){
		$.post("{% url 'chatroom:post' %}",
			$("#messageForm").serialize(),
			function(data){
				$("#content").val("");
				//chat = JSON.parse(data);
				//id = chat["pk"];
				//user = chat["field"]["user"];
				//ct = chat["field"]["said_time"];
				//said = chat["field"]["said"];
				//$(".chat-discussion").append("<dt class='text-left'>" + user + "-" + ct + "</dt>");
				//$(".chat-discussion").append("<dd class='text-left'>" + said + "</dd>");
				//$(".chat-discussion").append("<input type='hidden' class='chat_list' value='" + id + "'>");
		});
		return false;
	});
})
</script>
<script type="text/javascript">
    function updateMsg(){
	    last_id = $(".chat_list").last().val();
	    if (last_id){
	    }else{
		    last_id = "0";
	    }
	    $.post(
		    "{% url 'chatroom:post' %}",{
			    post_type:"get",
			    room_id: {{ id }},
			    last_chat: last_id,
		    },
		    function(data){
			    obj = JSON.parse(data);
			    for (var i=0;i<obj.length;i++){
				    chat = obj[i];
				    id = chat["pk"];
				    user = chat["fields"]["user"];
				    //ct = chat["fields"]["said_time"];
				    var st = new Date(chat["fields"]["said_time"]);
				    ct = st.toLocaleString();
				    said = chat["fields"]["said"];
				    $(".chat-discussion").append("<hr />")
				    $(".chat-discussion").append("<dt class='text-left'>" + user + "-" + ct + "</dt>");
				    $(".chat-discussion").append("<dd class='text-left'>" + said + "</dd>");
				    $(".chat-discussion").append("<input type='hidden' class='chat_list' value='" + id + "'>");
			    }
		    }
	    );
    }
    setInterval(updateMsg, 1000);
    </script>

<div class="container">
	<div class="row">
		<div class="col-sm-8 col-sm-offset-2">
			<form id="messageForm" action="." method="post">
			{% csrf_token %}
				<div class="input-group">
					<input type="text" name="message" id="content" class="form-control" autofocus="autofocus">
					<input type="hidden" name="post_type" value="send">
					<input type="hidden" name="room_id" value="{{ id }}">
					<span class="input-group-btn">
						<button type="submit" id="send" class="btn btn-default">send</button>
					</span>
				</div>
			</form>
		</div>
		<br />
		{% if chats %}
		<div class="col-sm-6 col-sm-offset-3">
			<dl class="chat-discussion">
				{% for chat in chats %}
					<!--<hr />
					{% if forloop.counter|divisibleby:"2" %}
						<dt class="text-right">{{ chat.user.name }}   {{ chat.said_time }}</dt>
						<dd class="text-right">{{ chat.said }}</dd>
					{% else %}
						<dt class="text-left">{{ chat.user.name }}   {{ chat.said_time }}</dt>
						<dd class="text-left">{{ chat.said }}</dd>
					{% endif %}-->
					<hr />
					<dt class="text-left">{{ chat.user.name }}   {{ chat.said_time }}</dt>
					<dd class="text-left">{{ chat.said }}</dd>
					<input type="hidden" class="chat_list" value="{{ chat.id }}">
				{% endfor %}
			</dl>
		</div>
		{% else %}
		<div class="col-sm-8 col-sm-offset-2">
			<dl class="chat-discussion">
				<dt class="text-left">Here is room: {{ id }}</dt>
				<dd class="text-left">Start your chat now.</dd>
			</dl>
		</div>
		{% endif %}
		<input type="hidden" class="test" value="123">
	</div>
</div>

{% endblock %}